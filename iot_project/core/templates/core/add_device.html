{% extends 'base.html' %}
{% load static %}

{% block title %}Smart IoT - Add Device{% endblock %}

{% block head_extra %}
<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Orbitron:wght@400;500;700&display=swap"
    rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
<style>
    /* IoT Theme Colors from homepage.html */
    :root {
        --background: hsl(222, 47%, 4%);
        --foreground: hsl(210, 40%, 98%);
        --card: hsl(222, 47%, 8%);
        --card-foreground: hsl(210, 40%, 98%);
        --primary: hsl(195, 100%, 50%);
        /* Main accent blue */
        --primary-foreground: hsl(222, 47%, 4%);
        /* Text on primary */
        --secondary: hsl(260, 60%, 65%);
        /* Purple accent */
        --accent: hsl(180, 100%, 50%);
        /* Cyan accent */
        --muted: hsl(222, 47%, 12%);
        /* Muted background */
        --muted-foreground: hsl(215, 20%, 65%);
        /* Muted text */
        --border: hsl(222, 47%, 20%);
        --input: hsl(222, 47%, 12%);
        --ring: hsl(195, 100%, 50%);
        /* Primary accent for focus rings */
        --destructive: hsl(0, 84%, 60%);
        /* Red for errors */

        /* Gradients from homepage.html */
        --gradient-primary: linear-gradient(135deg, var(--primary), var(--secondary));
        --gradient-cyber: linear-gradient(45deg, var(--primary), var(--accent));
        --gradient-glass: linear-gradient(135deg, hsla(222, 47%, 8%, 0.8), hsla(222, 47%, 12%, 0.4));
        --gradient-opposite: linear-gradient(135deg, hsl(85, 100%, 50%), var(--accent));

        /* Effects from homepage.html */
        --shadow-cyber: 0 0 30px hsla(195, 100%, 50%, 0.3);
        --shadow-glass: 0 8px 32px hsla(222, 47%, 4%, 0.3);

        color-scheme: dark;
        font-family: 'Inter', sans-serif;
    }

    body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: var(--background);
        color: var(--foreground);
        overflow-x: hidden;
        position: relative;
    }

    /* Enhanced Background Effects from homepage.html */
    body::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image:
            radial-gradient(circle at 20% 80%, hsla(195, 100%, 50%, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, hsla(260, 60%, 65%, 0.1) 0%, transparent 50%),
            linear-gradient(0deg, hsla(195, 100%, 50%, 0.08) 1px, transparent 1px),
            linear-gradient(90deg, hsla(195, 100%, 50%, 0.08) 1px, transparent 1px);
        background-size: 100% 100%, 100% 100%, 60px 60px, 60px 60px;
        background-position: 0% 0%, 0% 0%, 0 0, 0 0;
        opacity: 0.9;
        z-index: -2;
        animation: subtle-gradient-shift 20s ease-in-out infinite alternate;
    }

    .animated-grid {
        position: absolute;
        inset: 0;
        background-image:
            linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
        background-size: 50px 50px;
        z-index: -1;
        animation: pan-grid 60s linear infinite;
        opacity: 0.5;
    }

    @keyframes pan-grid {
        0% {
            background-position: 0 0;
        }

        100% {
            background-position: -50px -50px;
        }
    }

    body::after {
        content: '';
        position: fixed;
        inset: 0;
        background: repeating-linear-gradient(to bottom,
                transparent 0px,
                transparent 1px,
                rgba(0, 0, 0, 0.03) 1px,
                rgba(0, 0, 0, 0.03) 2px);
        pointer-events: none;
        z-index: 9999;
        opacity: 0.05;
    }

    .container {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        z-index: 10;
        /* Ensure content is on top of background effects */
    }

    .card-custom {
        background-color: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.05);
        padding: 2.5rem;
        width: 100%;
        max-width: 450px;
    }

    .form-group-custom {
        margin-bottom: 1.5rem;
    }

    .label-custom {
        display: block;
        font-size: 0.875rem;
        color: var(--muted-foreground);
        margin-bottom: 0.5rem;
    }

    .input-container-custom {
        position: relative;
        display: flex;
        align-items: center;
        height: 48px;
        background: var(--input);
        border: 1px solid var(--border);
        border-radius: 8px;
        transition: all 0.2s ease-in-out;
    }

    .input-custom,
    .select-custom {
        width: 100%;
        height: 100%;
        padding: 0.75rem 1rem;
        background: transparent;
        border: none;
        outline: none;
        color: var(--foreground);
        font-size: 1rem;
        border-radius: 8px;
    }

    /* Updated styling for the dropdown menu */
    .select-custom {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background: var(--input);
        color: var(--muted-foreground);
        cursor: pointer;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="hsl(215, 20%, 65%)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>');
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1.2rem;
    }

    .select-custom:focus {
        color: var(--foreground);
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="hsl(210, 40%, 98%)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>');
    }

    .input-custom::placeholder {
        color: var(--muted-foreground);
    }

    .input-container-custom:focus-within {
        box-shadow: 0 0 0 2px var(--ring);
    }

    .button-custom {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 8px;
        background: var(--gradient-cyber);
        color: var(--primary-foreground);
        border: none;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
    }

    .button-custom:hover {
        opacity: 0.9;
        box-shadow: var(--shadow-cyber);
    }

    h1.main-title {
        font-family: 'Orbitron', sans-serif;
        font-size: 2.2rem;
        font-weight: 700;
        background: var(--gradient-cyber);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 1rem;
        text-align: center;
    }

    .info-text {
        font-size: 0.9rem;
        color: var(--muted-foreground);
        text-align: center;
        margin-bottom: 2rem;
        line-height: 1.5;
    }

    .message-container {
        margin-bottom: 1rem;
    }

    .message {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-weight: 500;
    }

    .message.success {
        background-color: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .message.error {
        background-color: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.1);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border-left-color: var(--foreground);
        animation: spin 1s ease infinite;
        display: none;
        /* Hidden by default */
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Animations from homepage.html */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes subtle-gradient-shift {
        0% {
            background-position: 0% 0%, 0% 0%, 0 0, 0 0;
        }

        100% {
            background-position: 100% 100%, 100% 100%, 60px 60px, 60px 60px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="animated-grid"></div>
<div class="container">
    <div class="card-custom">
        <h1 class="main-title">Add a New Device</h1>
        <p class="info-text">
            To link your new IoT device, enter its unique API key and details. This key
            is found on the device itself or in its setup guide. Once linked, you can
            start monitoring and controlling your device from your dashboard.
        </p>

        <div id="message-container"></div>
        <form id="add-device-form" method="post" action="{% url 'add_device_to_user' %}">
            {% csrf_token %}

            <div class="form-group-custom">
                <label for="id_device_api_key" class="label-custom">Device API Key</label>
                <div class="input-container-custom">
                    <input type="text" id="id_device_api_key" name="device_api_key" class="input-custom"
                        placeholder="Enter the key from your device" required>
                </div>
            </div>

            <div class="form-group-custom">
                <label for="id_device_name" class="label-custom">Device Name</label>
                <div class="input-container-custom">
                    <input type="text" id="id_device_name" name="device_name" class="input-custom"
                        placeholder="e.g., Living Room AC" required>
                </div>
            </div>

            <div class="form-group-custom">
                <label for="id_device_type" class="label-custom">Device Type</label>
                <div class="input-container-custom">
                    <select id="id_device_type" name="device_type" class="select-custom" required>
                        <option value="" disabled selected>Select a device type</option>
                        <option value="power_monitor_switch">Power Monitoring & Switch</option>
                        <option value="water_level_sensor">Water Level Sensor</option>
                    </select>
                </div>
            </div>

            <div class="form-group-custom">
                <label for="id_location" class="label-custom">Location</label>
                <div class="input-container-custom">
                    <input type="text" id="id_location" name="location" class="input-custom"
                        placeholder="e.g., Home, Nashik" required>
                </div>
            </div>

            <button type="submit" id="submit-button" class="button-custom">
                <span id="button-text">Link Device</span>
                <div id="spinner" class="spinner mx-auto"></div>
            </button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('add-device-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        const messageContainer = document.getElementById('message-container');
        const deviceApiKeyInput = document.getElementById('id_device_api_key');
        const deviceNameInput = document.getElementById('id_device_name');
        const deviceTypeSelect = document.getElementById('id_device_type');
        const deviceSerialNumberInput = document.getElementById('id_device_serial_number');
        const locationInput = document.getElementById('id_location');

        function displayMessage(text, type) {
            if (!messageContainer) return;
            messageContainer.innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        form.addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission

            submitButton.disabled = true;
            buttonText.style.display = 'none';
            spinner.style.display = 'block';
            messageContainer.innerHTML = ''; // Clear previous messages

            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: formData
            })
                .then(response => response.json().then(json => {
                    if (response.ok) {
                        return Promise.resolve(json);
                    } else {
                        return Promise.reject(json);
                    }
                }))
                .then(data => {
                    // Handle success response without redirecting
                    displayMessage(data.message, 'success');
                    // Clear the input fields for a better user experience
                    deviceApiKeyInput.value = '';
                    deviceNameInput.value = '';
                    deviceTypeSelect.value = '';
                    deviceSerialNumberInput.value = '';
                    locationInput.value = '';
                })
                .catch(error => {
                    // Handle error response
                    const errorMessage = error.message || 'An unexpected error occurred.';
                    displayMessage(errorMessage, 'error');
                })
                .finally(() => {
                    // Reset button state
                    submitButton.disabled = false;
                    buttonText.style.display = 'block';
                    spinner.style.display = 'none';
                });
        });
    });
</script>
{% endblock %}